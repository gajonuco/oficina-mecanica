<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <title>Painel do Atendente</title>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> 
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    </head>
    
<body>
<h1>Painel do Atendente</h1>
<ul id="lista-notificacoes"></ul>
<button onclick="limparNotificacoes()">Limpar notificações</button>

<script>
    const token = sessionStorage.getItem('token');
    let stompClient = null;

    if (!token) {
        alert("Você precisa estar logado.");
        window.location.href = "login.html";
    }

        // Após verificar o token e tipo de usuário
    axios.get('http://localhost:8080/api/solicitacoes', {
        headers: { Authorization: `Bearer ${token}` }
    })
    .then(response => {
        const lista = document.getElementById('lista-notificacoes');
        response.data.forEach(solicitacao => {
            const item = document.createElement('li');
            item.textContent = `${solicitacao.cliente.nome} solicitou: ${solicitacao.nomeServico} em ${solicitacao.dataHora}`;
            lista.appendChild(item);
        });
    })
    .catch(error => {
        console.error("Erro ao carregar solicitações:", error);
    });


    function connectWebSocket() {
        const socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({ Authorization: 'Bearer ' + token }, frame => {
            console.log("Conectado como atendente:", frame);
            stompClient.subscribe("/topic/notifications", message => {
                const solicitacao = JSON.parse(message.body);
                const item = document.createElement('li');
                item.textContent = `${solicitacao.nomeCliente} solicitou: ${solicitacao.nomeServico} em ${solicitacao.dataHora}`;
                document.getElementById('lista-notificacoes').appendChild(item);

            });


        }, error => {
            console.error("Erro WebSocket:", error);
        });
    }

    function limparNotificacoes() {
        const lista = document.getElementById('lista-notificacoes');
        lista.innerHTML = ''; // limpa tudo visualmente
    }


    connectWebSocket();


</script>
</body>
</html>
